---
title: "Plotting Functionality in tcplfit2"
author: "Center for Computational Toxicology and Exposure"
output:
   prettydoc::html_pretty:
    theme: architect
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{Plot_with_tcplfit2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, packages, warning=FALSE, message=FALSE}
library(tcplfit2)
library(dplyr)
library(stringr)
library(ggplot2)
library(gridExtra)
```

```{r, include=FALSE}
source("~/CompTox-ToxCast-tcplFit2/R/concRespPlot2.R")
source("~/CompTox-ToxCast-tcplFit2/R/plot_allcurves.R")
```


# Introduction
This vignette demonstrates how to plot concentration-response modeling curves with two `ggplot2 based` plotting functions in `tcplfit2`: `plot_allcurves` and `concRespPlot2`. 

`plot_allcurves` plots the observed concentration-response data along with all the model fits, and `concRespPlot2` plots a basic plot of the data with the winning model. Both functions return `ggplot` objects which are capable of being customized to have additional details, such as labels for cutoff, BMR, BMD, BMD confident interval, and other curve fits, etc. with `ggplot2` add-ons. How to add layers to the plot will also be demonstrated in the vignette. 

# Plot All Curves From tcplfit2_core
`plot_allcurves` takes in output from `tcplfit2_core` and plots the concentration response data along with all the model fits. The `log_conc` argument allows users to convert the x-axis (concentration) into `log-10` scale. Using the first row of `signature` data set as an example. 
```{r}
# using the first row of signature as an example 
data("signatures")
conc=as.numeric(str_split(signatures[1,"conc"],"\\|")[[1]])
resp=as.numeric(str_split(signatures[1,"resp"],"\\|")[[1]])
cutoff=signatures[1,"cutoff"]

# run curve fitting
output <- tcplfit2_core(conc, resp, cutoff)

# get plots in normal and in log-10 concentration scale
basic <- plot_allcurves(output, conc, resp)
basic_log <- plot_allcurves(output, conc, resp, log_conc = T)
grid.arrange(basic, basic_log)
```

**Figure 1**: These two plots are example of plots generated by `plot_allcurves`. The basic plot displays the observed data points and all the model fits. The top is the plot in normal concentration scale, and the bottom plot is the same but with concentration converted into `log-10` scale using `log_conc=TRUE`.

# Plot the Winning Curve
`concRespPlot2` takes in output from `concRespCore` or `tcplhit2_core` and generates a basic plot displaying the observed concentration response data and the wining curve. Argument `log_conc` is also available to convert the x-axis (concentration) into `log-10` scale. 
```{r}
row = list(conc=conc,
           resp=resp,
           bmed=0,
           cutoff=cutoff,
           onesd=signatures[1,"onesd"],
           name=signatures[1,"name"],
           assay=signatures[1,"signature"])

# run concentration-response modeling 
out = concRespCore(row,conthits=F)
basic_plot <- concRespPlot2(out)
basic_log <- concRespPlot2(out, log_conc = TRUE)
grid.arrange(basic_plot, basic_log)
```

**Figure 2**: These two plots are example of plots generated by `concRespPlot2`. The basic plot displays the observed data points and the winning model curve. The top is the plot in normal concentration scale, and the bottom plot is the same but with concentration converted into `log-10` scale using `log_conc=TRUE`.

# Customaization
This section will show one how to add some commonly desired details to the basic plot generated by `concRespPlot2`. The following code chunk shows how one can add titles to include identification information for the compound and assay, and labels for cutoff region and the estimated BMD value.
```{r}
# Using the fitted result and plot from the example in the last section
# get the cutoff from the output
cutoff <- out[, "cutoff"]


basic_plot + 
  # Cutoff Band - a transparent rectangle
  geom_rect(aes(xmin = 0,xmax = 30,ymin = -cutoff,ymax = cutoff),
            alpha = 0.1,fill = "skyblue") +
  # Titles
  ggtitle(
    label = paste("Best Model Fit",
                  out[, "name"],
                  sep = "\n"),
    subtitle = paste("Assay Endpoint: ",
                     out[, "assay"])) +
  ## Add BMD and BMR labels
  geom_hline(
    aes(yintercept = out[, "bmr"]),
    col = "blue") +
  geom_segment(
    aes(x = out[, "bmd"], xend = out[, "bmd"], y = -0.5, yend = out[, "bmr"]),
    col = "blue"
  ) + geom_point(aes(x = out[, "bmd"], y = out[, "bmr"], fill = "BMD"), shape = 21, cex = 2.5)
```

**Figure 3**: This plot shows the basic plot from `concRespPlot2` with additional details. The title and subtitle display the compound name and assay endpoint. A light blue band represents the cutoff region. A red point and blue segments label the estimated BMD and BMR on the winning curves.

There are more potency estimates returned from `concRespCore` or `tcplhit2_core` (e.g. AC50). The following code chunk demonstrates how to add point labels for multiple potency estimates at a time. One can re-use the lines of `geom_hline` and `geom_segment` from above to add segment labels separately if desired. 
```{r}
# Get all potency estimates and the corresponding y value on the curve
estimate_points <- out %>%
  select(bmd, acc, ac50, ac10, ac5) %>%
  tidyr::pivot_longer(everything(), names_to = "Potency Estimates") %>%
  mutate(`Potency Estimates` = toupper(`Potency Estimates`)) 

y = c(out[, "bmr"], out[, "cutoff"], rep(out[, "top"], 3))
y = y * c(1, 1, .5, .1, .05)
estimate_points <- cbind(estimate_points, y = y)

# add Potency Estimate Points and set colors
basic_plot + geom_point(
  data = estimate_points,
  aes(x = value, y = y, fill = `Potency Estimates`), shape = 21, cex = 2.5
)
```

**Figure 4**: This plot shows you basic plot generated by `concRespPlot2` with highlighted potency estimated on the fitted curve.

## Add Another Curve
This sub-section demonstrates how one can add another curve for comparison. One has to simulate other curves for comparison and overlay them on the basic plot from `concRespPlot2`. 
```{r}
# maybe want to extract and use the same x's in the base plot 
# to calculate a smooth curve 
conc_plot <- basic_plot[["layers"]][[2]][["data"]][["conc_plot"]]

basic_plot +
  # fitted parameter values of another cueve you want to add
  geom_line(data=data.frame(x=conc_plot, y=tcplfit2::exp5(c(0.5, 10, 1.2), conc_plot)), aes(x,y,color = "exp5"))+
  # add different colors for comparisons 
  scale_colour_manual(values=c("#CC6666", "#9999CC"),
                      labels = c("Chemical X-exp4", "Chemical Y-exp5")) +
  labs(title = "Chemical X v.s. Chemical Y")
```

**Figure 5**: This plot shows you basic plot generated by `concRespPlot2` with another fitted curve added.

## Log Scale
When adding additional details to plots which have `log_conc = TRUE`, the values for the labels need to be log-transformed as well in order to be laid on the correct position on the transformed curve (as demonstrated below). 
```{r}
# add Potency Estimate Points and set colors - with plot in log-10 concentration
basic_log + geom_point(
  data = estimate_points,
  aes(x = log10(value), y = y, fill = `Potency Estimates`), shape = 21, cex = 2.5
)
```

**Figure 5**: Example basic plot generated by `concRespPlot2` with concentration (x-axis) converted into `log-10` scale using `log_conc=TRUE`. Potency estimates `AC5`, `AC10`, `AC50`, `ACC` and `BMD` are highlighted on the curve. 






