---
title: "Concentration-Response Plotting with tcplfit2"
author: "Center for Computational Toxicology and Exposure"
output:
   prettydoc::html_pretty:
    theme: architect
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{Plot_with_tcplfit2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# R Packages
```{r setup, packages, warning=FALSE, message=FALSE}
# Primary Packages #
library(tcplfit2)
# Data Formatting Packages #
library(dplyr)
library(stringr)
# Plotting Packages #
library(ggplot2)
library(gridExtra)
```

# Introduction
`tcplfit2` performs concentration-response curve fitting. The package provides several plotting functionalities for visualizing the fitted curves. This vignette focuses on demonstrating two, namely `plot_allcurves` and `concRespPlot2`. The following sections will demonstrate how to use them and how to add customized details to the plots with `ggplot2` based functions.

The example input data used in this vignette comes from the `signature` data. It contains 6 signatures (assay endpoints) for one chemical in a transcriptomics data set. One row in the data represents a different chemical-assay endpoint pair and provides the cutoff, one standard deviation, and the concentration-response data. We will only use the first row.
```{r}
# Load the example data set
data("signatures")
# using the first row of signatures data as an example 
signatures[1,]
```

# Plot All Curves From tcplfit2_core
The user might want to evaluate all curve fits from `tcplfit2_core`, and `plot_allcurves` enables that. To utilize this function, the user must run `tcplfit2_core` separately to obtain the output object that's going to be passed into `plot_allcurves`. The resulting figure provides a quick glance at the general behaviors and the qualities of curve fits. Furthermore, because any curves failed to fit will not be included in the plot and a warning message will be provided, user will know which type of curve is or is not able to describe the data. If the user wants to have the plot returned with concentrations in `log-10` scale, one can do it by setting the `log_conc` argument to `TRUE`.
```{r}
# using the first row of signature as an example 
conc=as.numeric(str_split(signatures[1,"conc"],"\\|")[[1]])
resp=as.numeric(str_split(signatures[1,"resp"],"\\|")[[1]])
cutoff=signatures[1,"cutoff"]

# run curve fitting
output <- tcplfit2_core(conc, resp, cutoff)
# show the structure of the output 
summary(output)
```

```{r}
# get plots in normal and in log-10 concentration scale
basic <- plot_allcurves(output, conc, resp)
basic_log <- plot_allcurves(output, conc, resp, log_conc = T)
grid.arrange(basic, basic_log)
```

**Figure 1**: These two plots are examples of plots generated by `plot_allcurves`. The top plot is the original plot, and the bottom plot is the original plot with `log-10` concentrations.

# Plot the Winning Curve
The user might want to see the data with just the winning curve. One can archive that with the `concRespPlot2` function. The resulting plot contains minimal information and that gives the user the most flexibility to decorate the plot with additional details to make it more informative. More on this is discussed in the Customization section. Argument `log_conc` is also available in this function to have the plot returned with concentrations in `log-10` scale.
```{r}
# prepare the 'row' object for concRespCore
row = list(conc=conc,
           resp=resp,
           bmed=0,
           cutoff=cutoff,
           onesd=signatures[1,"onesd"],
           name=signatures[1,"name"],
           assay=signatures[1,"signature"])

# run concentration-response modeling 
out = concRespCore(row,conthits=F)
# show the output
out
```

```{r}
# pass the output to the plotting function
basic_plot <- concRespPlot2(out)
basic_log <- concRespPlot2(out, log_conc = TRUE)
grid.arrange(basic_plot, basic_log)
```

**Figure 2**: These two plots are examples of plots generated by `concRespPlot2`. The top plot is the original plot, and the bottom plot is the original plot with `log-10` concentrations.

# Customization
This section provides some examples of how the user may add additional information to the basic plot returned by `concResPlot2.` The demonstrations are done with `ggplot2` based functions as of the current version of `concRespPlot2` returns a `ggplot` object, so itâ€™s convenient to add layers directly to it with `+` operator.

The user might want to add titles displaying the compound and assay endpoint or want to visualize the cutoff band to see how much the responses have gotten above or below the threshold. The user may use points and lines to label important estimates such as BMD and BMR on the curve and axes to see where they are relative to the experimental data.
```{r}
# Using the fitted result and plot from the example in the last section
# get the cutoff from the output
cutoff <- out[, "cutoff"]


basic_plot + 
  # Cutoff Band - a transparent rectangle
  geom_rect(aes(xmin = 0,xmax = 30,ymin = -cutoff,ymax = cutoff),
            alpha = 0.1,fill = "skyblue") +
  # Titles
  ggtitle(
    label = paste("Best Model Fit",
                  out[, "name"],
                  sep = "\n"),
    subtitle = paste("Assay Endpoint: ",
                     out[, "assay"])) +
  ## Add BMD and BMR labels
  geom_hline(
    aes(yintercept = out[, "bmr"]),
    col = "blue") +
  geom_segment(
    aes(x = out[, "bmd"], xend = out[, "bmd"], y = -0.5, yend = out[, "bmr"]),
    col = "blue"
  ) + geom_point(aes(x = out[, "bmd"], y = out[, "bmr"], fill = "BMD"), shape = 21, cex = 2.5)
```

**Figure 3**: This plot shows the basic plot from `concRespPlot2` with additional details. The title and subtitle display the compound name and assay endpoint. A light blue band represents the cutoff region. A red point and blue segments label the estimated BMR and BMD on the winning curves.

There are more potency estimates returned in the output from `concRespCore` or `tcplhit2_core` (e.g. AC50, ACC, etc.) If the user wants to visualize them all, the code chunk below provides a way to do so. Note that when adding labels to plots with `log_conc = TRUE`, the values need to be log-transformed as well in order to be laid on the correct positions on the transformed curve.
```{r}
# Get all potency estimates and the corresponding y value on the curve
estimate_points <- out %>%
  select(bmd, acc, ac50, ac10, ac5) %>%
  tidyr::pivot_longer(everything(), names_to = "Potency Estimates") %>%
  mutate(`Potency Estimates` = toupper(`Potency Estimates`)) 

y = c(out[, "bmr"], out[, "cutoff"], rep(out[, "top"], 3))
y = y * c(1, 1, .5, .1, .05)
estimate_points <- cbind(estimate_points, y = y)

# add Potency Estimate Points and set colors
basic_plot + geom_point(
  data = estimate_points,
  aes(x = value, y = y, fill = `Potency Estimates`), shape = 21, cex = 2.5
)
```

**Figure 4**: This plot shows you basic plot generated by `concRespPlot2` with highlighted potency estimates.

```{r}
# add Potency Estimate Points and set colors - with plot in log-10 concentration
basic_log + geom_point(
  data = estimate_points,
  aes(x = log10(value), y = y, fill = `Potency Estimates`), shape = 21, cex = 2.5
)
```

**Figure 5**: Example basic plot generated by `concRespPlot2` with `log-10` concentration. Potency estimates `AC5`, `AC10`, `AC50`, `ACC` and `BMD` are highlighted on the curve. 

## Add Another Curve
Working with `ggplot2` based function enables us to accommodate users with unique plotting needs. For example, the user might want to add other fitted curves of different compounds, or of different experimental scenarios, to the basic plot for comparisons. To do that, the user needs to know what model one wants to plot and the estimated parameters for that model. Then, the user can use them to generate a series of predicted responses and plot the curve on the basic plot. This section shows some example codes the user may use to add another curve. The codes can be generalized to add more than one curve.
```{r}
# maybe want to extract and use the same x's in the base plot 
# to calculate predicted responses 
conc_plot <- basic_plot[["layers"]][[2]][["data"]][["conc_plot"]]

basic_plot +
  # fitted parameter values of another curve you want to add
  geom_line(data=data.frame(x=conc_plot, y=tcplfit2::exp5(c(0.5, 10, 1.2), conc_plot)), aes(x,y,color = "exp5"))+
  # add different colors for comparisons 
  scale_colour_manual(values=c("#CC6666", "#9999CC"),
                      labels = c("Curve 1-exp4", "Curve 2-exp5")) +
  labs(title = "Curve 1 v.s. Curve 2")
```

**Figure 5**: This plot shows a basic plot generated by `concRespPlot2` with another curve added.

