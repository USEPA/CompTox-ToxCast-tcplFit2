---
title: "Concentration-Response Plotting with tcplfit2"
author: "Center for Computational Toxicology and Exposure"
output:
   prettydoc::html_pretty:
    theme: architect
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{Plot_with_tcplfit2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# R Packages
```{r setup, packages, warning=FALSE, message=FALSE}
# Primary Packages #
library(tcplfit2)
# Data Formatting Packages #
library(dplyr)
library(stringr)
# Plotting Packages #
library(ggplot2)
library(gridExtra)
```

# Introduction
This vignette demonstrates how to plot concentration-response curves with plotting functions in `tcplfit2`, namely `plot_allcurves` and `concRespPlot2`, and how to add customized details to the plots with `ggplot2` based functions.

# Plot All Curves From tcplfit2_core
`plot_allcurves` takes in output from `tcplfit2_core` and plots the observed concentration-response data along with all the model fits. The `log_conc` argument allows users to convert the x-axis (concentrations) into `log-10` scale. 
```{r}
# using the first row of signature as an example 
data("signatures")
conc=as.numeric(str_split(signatures[1,"conc"],"\\|")[[1]])
resp=as.numeric(str_split(signatures[1,"resp"],"\\|")[[1]])
cutoff=signatures[1,"cutoff"]

# run curve fitting
output <- tcplfit2_core(conc, resp, cutoff)

# get plots in normal and in log-10 concentration scale
basic <- plot_allcurves(output, conc, resp)
basic_log <- plot_allcurves(output, conc, resp, log_conc = T)
grid.arrange(basic, basic_log)
```

**Figure 1**: These two plots are example of plots generated by `plot_allcurves`. The top plot is the original plot, and the bottom plot is the original plot with `log-10` concentrations.

# Plot the Winning Curve
`concRespPlot2` takes in output from `concRespCore` or `tcplhit2_core` and plots the observed concentration-response data and the winning curve. Argument `log_conc` is also available in this function.
```{r}
# prepare the 'row' object for concRespCore
row = list(conc=conc,
           resp=resp,
           bmed=0,
           cutoff=cutoff,
           onesd=signatures[1,"onesd"],
           name=signatures[1,"name"],
           assay=signatures[1,"signature"])

# run concentration-response modeling 
out = concRespCore(row,conthits=F)

# pass the output to the plotting function
basic_plot <- concRespPlot2(out)
basic_log <- concRespPlot2(out, log_conc = TRUE)
grid.arrange(basic_plot, basic_log)
```

**Figure 2**: These two plots are example of plots generated by `concRespPlot2`. The top plot is the original plot, and the bottom plot is the original plot with `log-10` concentrations.

# Customization
This section shows how users can add some commonly desired details to the basic plot generated by `concRespPlot2` with `ggplot2` based functions. `concRespPlot2` returns a `ggplot` object, so we can add layers directly to it with `+` operator.

Below are some example codes to add titles and labels for cutoff region and the estimated BMD value to the `basic_plot` object created from the last section. 
```{r}
# Using the fitted result and plot from the example in the last section
# get the cutoff from the output
cutoff <- out[, "cutoff"]


basic_plot + 
  # Cutoff Band - a transparent rectangle
  geom_rect(aes(xmin = 0,xmax = 30,ymin = -cutoff,ymax = cutoff),
            alpha = 0.1,fill = "skyblue") +
  # Titles
  ggtitle(
    label = paste("Best Model Fit",
                  out[, "name"],
                  sep = "\n"),
    subtitle = paste("Assay Endpoint: ",
                     out[, "assay"])) +
  ## Add BMD and BMR labels
  geom_hline(
    aes(yintercept = out[, "bmr"]),
    col = "blue") +
  geom_segment(
    aes(x = out[, "bmd"], xend = out[, "bmd"], y = -0.5, yend = out[, "bmr"]),
    col = "blue"
  ) + geom_point(aes(x = out[, "bmd"], y = out[, "bmr"], fill = "BMD"), shape = 21, cex = 2.5)
```

**Figure 3**: This plot shows the basic plot from `concRespPlot2` with additional details. The title and subtitle display the compound name and assay endpoint. A light blue band represents the cutoff region. A red point and blue segments label the estimated BMR and BMD on the winning curves.

There are more potency estimates returned from `concRespCore` or `tcplhit2_core` (e.g. AC50). The following code chunk demonstrates how to add point labels for multiple potency estimates at a time. Note that when adding labels to plots with `log_conc = TRUE`, the values need to be log-transformed as well in order to be laid on the correct position on the transformed curve.
```{r}
# Get all potency estimates and the corresponding y value on the curve
estimate_points <- out %>%
  select(bmd, acc, ac50, ac10, ac5) %>%
  tidyr::pivot_longer(everything(), names_to = "Potency Estimates") %>%
  mutate(`Potency Estimates` = toupper(`Potency Estimates`)) 

y = c(out[, "bmr"], out[, "cutoff"], rep(out[, "top"], 3))
y = y * c(1, 1, .5, .1, .05)
estimate_points <- cbind(estimate_points, y = y)

# add Potency Estimate Points and set colors
basic_plot + geom_point(
  data = estimate_points,
  aes(x = value, y = y, fill = `Potency Estimates`), shape = 21, cex = 2.5
)
```

**Figure 4**: This plot shows you basic plot generated by `concRespPlot2` with highlighted potency estimates.

```{r}
# add Potency Estimate Points and set colors - with plot in log-10 concentration
basic_log + geom_point(
  data = estimate_points,
  aes(x = log10(value), y = y, fill = `Potency Estimates`), shape = 21, cex = 2.5
)
```

**Figure 5**: Example basic plot generated by `concRespPlot2` with `log-10` concentration. Potency estimates `AC5`, `AC10`, `AC50`, `ACC` and `BMD` are highlighted on the curve. 

## Add Another Curve
This section demonstrates how users can add another curve for comparison. The user has to use the fitted parameter values of the another curve to simulate a series of responses (can do it with the same X's `concRespCore` used or simulate a different series of X's), and plot the curve on the basic plot with `geom_line()`. This process can be generalized to add more than one fitted curve.
```{r}
# maybe want to extract and use the same x's in the base plot 
# to calculate a smooth curve 
conc_plot <- basic_plot[["layers"]][[2]][["data"]][["conc_plot"]]

basic_plot +
  # fitted parameter values of another curve you want to add
  geom_line(data=data.frame(x=conc_plot, y=tcplfit2::exp5(c(0.5, 10, 1.2), conc_plot)), aes(x,y,color = "exp5"))+
  # add different colors for comparisons 
  scale_colour_manual(values=c("#CC6666", "#9999CC"),
                      labels = c("Chemical X-exp4", "Chemical Y-exp5")) +
  labs(title = "Chemical X v.s. Chemical Y")
```

**Figure 5**: This plot shows a basic plot generated by `concRespPlot2` with another fitted curve added.

